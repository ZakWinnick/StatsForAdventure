{% extends "base.html" %}

{% block title %}{{ vehicle.name }} - Rivian Dashboard{% endblock %}

{% block head %}
<style>
    .battery-indicator {
        background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 50%, #FFC107 100%);
        height: 20px;
        border-radius: 10px;
        margin-top: 5px;
    }
    
    .card-hover:hover {
        transform: translateY(-5px);
        transition: transform 0.3s ease;
    }
    
    .status-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-online {
        background-color: #4CAF50;
    }
    
    .status-offline {
        background-color: #F44336;
    }

    .command-history-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }

    .command-history-item:hover {
        background-color: #f8f9fa;
    }
</style>
<!-- Add CSRF token for API requests -->
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<!-- Alerts Container -->
<div id="alerts-container"></div>

<!-- Vehicle Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="display-6 mb-0">
            {% if vehicle.vehicle.model == "R1T" %}
            <i class="fas fa-truck-pickup me-2"></i>
            {% elif vehicle.vehicle.model == "R1S" %}
            <i class="fas fa-car-side me-2"></i>
            {% else %}
            <i class="fas fa-car me-2"></i>
            {% endif %}
            {{ vehicle.name }}
        </h1>
        <p class="text-muted">
            {{ vehicle.vehicle.model }} ({{ vehicle.vehicle.modelYear }})
            <span class="ms-2 badge bg-{{ 'success' if vehicle.state == 'ACTIVATED' else 'secondary' }}">
                {{ vehicle.state|title }}
            </span>
        </p>
    </div>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
</div>

<!-- Real-time Updates Info -->
<div class="alert alert-info mb-4">
    <i class="fas fa-sync-alt me-2"></i>
    <span id="connection-status">Connecting to real-time updates...</span>
</div>

<!-- Connection Status & Battery Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-wifi me-2"></i>Connection Status
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center">
                    {% set is_online = vehicle_state.cloudConnection.lastSync %}
                    <div class="status-circle {{ 'status-online' if is_online else 'status-offline' }}" id="online-status-indicator"></div>
                    <div class="flex-grow-1">
                        <h5 class="mb-0" id="online-status-text">{{ 'Online' if is_online else 'Offline' }}</h5>
                        {% if is_online %}
                        <small class="text-muted">
                            Last connected: <span id="last-sync">{{ vehicle_state.cloudConnection.lastSync }}</span>
                        </small>
                        {% else %}
                        <small class="text-muted" id="last-sync-container">Vehicle is not connected to the cloud</small>
                        {% endif %}
                    </div>
                </div>
                
                <hr>
                
                <div class="d-flex align-items-center mt-3">
                    <div class="me-3">
                        <i class="fas fa-power-off fa-2x {{ 'text-success' if vehicle_state.powerState.value == 'ready' else 'text-secondary' }}" id="power-state-icon"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Power State</h5>
                        <small class="text-muted" id="power-state">{{ vehicle_state.powerState.value|title }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-battery-three-quarters me-2"></i>Battery Status
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <h3 class="mb-0" id="battery-percentage">{{ "%.1f"|format(vehicle_state.batteryLevel.value) }}%</h3>
                    <h5 class="mb-0">
                        <span id="distance-to-empty">{{ vehicle_state.distanceToEmpty.value }}</span> miles
                    </h5>
                </div>
                
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ vehicle_state.batteryLevel.value }}%;" 
                         id="battery-progress">
                        {{ "%.1f"|format(vehicle_state.batteryLevel.value) }}%
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="text-center">
                            <i class="fas fa-plug fa-2x mb-2 {{ 'text-success' if vehicle_state.chargerState.value == 'charging_active' else 'text-secondary' }}" id="charging-state-icon"></i>
                            <h6 class="mb-0" id="charging-state">
                                {{ vehicle_state.chargerState.value|replace('_', ' ')|title }}
                            </h6>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <i class="fas fa-battery-full fa-2x mb-2"></i>
                            <h6 class="mb-0">
                                Limit: <span id="battery-limit">{{ vehicle_state.batteryLimit.value }}</span>%
                            </h6>
                        </div>
                    </div>
                </div>
                
                <div id="charging-data-container" class="{{ 'd-none' if not charging_data or not charging_data.vehicleChargerState or charging_data.vehicleChargerState.value != 'charging_active' else '' }}">
                    <hr>
                    <div class="mt-3">
                        <h6>Charging Information</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Power:</small>
                                <div id="charging-power">{{ charging_data.power.value if charging_data and charging_data.power else 'N/A' }} kW</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Time Remaining:</small>
                                <div id="charging-time-remaining">{{ (charging_data.timeRemaining.value / 60)|int if charging_data and charging_data.timeRemaining else 'N/A' }} mins</div>
                            </div>
                            <div class="col-6 mt-2">
                                <small class="text-muted">Added Range:</small>
                                <div id="charging-range-added">{{ charging_data.rangeAddedThisSession.value if charging_data and charging_data.rangeAddedThisSession else 'N/A' }} mi</div>
                            </div>
                            <div class="col-6 mt-2">
                                <small class="text-muted">Energy Added:</small>
                                <div id="charging-energy-added">{{ charging_data.totalChargedEnergy.value if charging_data and charging_data.totalChargedEnergy else 'N/A' }} kWh</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Status & Controls -->
<div class="row mb-4">
    <!-- Vehicle Status -->
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Vehicle Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Doors -->
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold"><i class="fas fa-door-open me-2"></i>Doors</h6>
                        <div class="ms-4">
                            <div>
                                Front Left: 
                                <span id="door-front-left-closed" class="badge {{ 'bg-success' if vehicle_state.doorFrontLeftClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.doorFrontLeftClosed.value|title }}
                                </span>
                                <span id="door-front-left-locked" class="badge {{ 'bg-success' if vehicle_state.doorFrontLeftLocked.value == 'locked' else 'bg-warning' }}">
                                    {{ vehicle_state.doorFrontLeftLocked.value|title }}
                                </span>
                            </div>
                            <div>
                                Front Right: 
                                <span id="door-front-right-closed" class="badge {{ 'bg-success' if vehicle_state.doorFrontRightClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.doorFrontRightClosed.value|title }}
                                </span>
                                <span id="door-front-right-locked" class="badge {{ 'bg-success' if vehicle_state.doorFrontRightLocked.value == 'locked' else 'bg-warning' }}">
                                    {{ vehicle_state.doorFrontRightLocked.value|title }}
                                </span>
                            </div>
                            <div>
                                Rear Left: 
                                <span id="door-rear-left-closed" class="badge {{ 'bg-success' if vehicle_state.doorRearLeftClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.doorRearLeftClosed.value|title }}
                                </span>
                                <span id="door-rear-left-locked" class="badge {{ 'bg-success' if vehicle_state.doorRearLeftLocked.value == 'locked' else 'bg-warning' }}">
                                    {{ vehicle_state.doorRearLeftLocked.value|title }}
                                </span>
                            </div>
                            <div>
                                Rear Right: 
                                <span id="door-rear-right-closed" class="badge {{ 'bg-success' if vehicle_state.doorRearRightClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.doorRearRightClosed.value|title }}
                                </span>
                                <span id="door-rear-right-locked" class="badge {{ 'bg-success' if vehicle_state.doorRearRightLocked.value == 'locked' else 'bg-warning' }}">
                                    {{ vehicle_state.doorRearRightLocked.value|title }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Windows -->
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold"><i class="fas fa-window-maximize me-2"></i>Windows</h6>
                        <div class="ms-4">
                            <div>
                                Front Left: 
                                <span id="window-front-left" class="badge {{ 'bg-success' if vehicle_state.windowFrontLeftClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.windowFrontLeftClosed.value|title }}
                                </span>
                            </div>
                            <div>
                                Front Right: 
                                <span id="window-front-right" class="badge {{ 'bg-success' if vehicle_state.windowFrontRightClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.windowFrontRightClosed.value|title }}
                                </span>
                            </div>
                            <div>
                                Rear Left: 
                                <span id="window-rear-left" class="badge {{ 'bg-success' if vehicle_state.windowRearLeftClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.windowRearLeftClosed.value|title }}
                                </span>
                            </div>
                            <div>
                                Rear Right: 
                                <span id="window-rear-right" class="badge {{ 'bg-success' if vehicle_state.windowRearRightClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.windowRearRightClosed.value|title }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Climate -->
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold"><i class="fas fa-temperature-half me-2"></i>Climate</h6>
                        <div class="ms-4">
                            <div>
                                Interior: <span id="cabin-temperature">{{ vehicle_state.cabinClimateInteriorTemperature.value }}</span>°C
                            </div>
                            <div>
                                Driver Setting: <span id="driver-temperature">{{ vehicle_state.cabinClimateDriverTemperature.value }}</span>°C
                            </div>
                            <div>
                                Preconditioning: 
                                <span id="preconditioning-status" class="badge {{ 'bg-success' if vehicle_state.cabinPreconditioningStatus.value != 'undefined' else 'bg-secondary' }}">
                                    {{ vehicle_state.cabinPreconditioningStatus.value|title }}
                                </span>
                            </div>
                            <div>
                                Pet Mode: 
                                <span id="pet-mode-status" class="badge {{ 'bg-success' if vehicle_state.petModeStatus.value == 'On' else 'bg-secondary' }}">
                                    {{ vehicle_state.petModeStatus.value }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Closures -->
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold"><i class="fas fa-box-open me-2"></i>Closures</h6>
                        <div class="ms-4">
                            <div>
                                Frunk: 
                                <span id="frunk-status" class="badge {{ 'bg-success' if vehicle_state.closureFrunkClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.closureFrunkClosed.value|title }}
                                </span>
                            </div>
                            {% if vehicle.vehicle.model == "R1T" %}
                            <div>
                                Gear Tunnel Left: 
                                <span id="gear-tunnel-left" class="badge {{ 'bg-success' if vehicle_state.closureSideBinLeftClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.closureSideBinLeftClosed.value|title }}
                                </span>
                            </div>
                            <div>
                                Gear Tunnel Right: 
                                <span id="gear-tunnel-right" class="badge {{ 'bg-success' if vehicle_state.closureSideBinRightClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.closureSideBinRightClosed.value|title }}
                                </span>
                            </div>
                            <div>
                                Tonneau Cover: 
                                <span id="tonneau-cover" class="badge {{ 'bg-success' if vehicle_state.closureTonneauClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.closureTonneauClosed.value|title }}
                                </span>
                            </div>
                            {% endif %}
                            <div>
                                Tailgate: 
                                <span id="tailgate-status" class="badge {{ 'bg-success' if vehicle_state.closureTailgateClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.closureTailgateClosed.value|title }}
                                </span>
                            </div>
                            {% if vehicle.vehicle.model == "R1S" %}
                            <div>
                                Liftgate: 
                                <span id="liftgate-status" class="badge {{ 'bg-success' if vehicle_state.closureLiftgateClosed.value == 'closed' else 'bg-danger' }}">
                                    {{ vehicle_state.closureLiftgateClosed.value|title }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Gear Guard -->
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold"><i class="fas fa-shield-alt me-2"></i>Gear Guard</h6>
                        <div class="ms-4">
                            <div>
                                Status: 
                                <span id="gear-guard-status" class="badge {{ 'bg-success' if vehicle_state.gearGuardLocked.value == 'locked' else 'bg-secondary' }}">
                                    {{ 'Enabled' if vehicle_state.gearGuardLocked.value == 'locked' else 'Disabled' }}
                                </span>
                            </div>
                            <div>
                                Video: 
                                <span id="gear-guard-video" class="badge {{ 'bg-success' if vehicle_state.gearGuardVideoMode.value == 'AUTO' else 'bg-secondary' }}">
                                    {{ vehicle_state.gearGuardVideoMode.value|title }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vehicle Info -->
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>Vehicle Info</h6>
                        <div class="ms-4">
                            <div>
                                Mileage: <span id="vehicle-mileage">{{ (vehicle_state.vehicleMileage.value / 1000)|int }}</span> miles
                            </div>
                            <div>
                                Software: <span id="vehicle-software">{{ vehicle_state.otaCurrentVersionYear.value }}.{{ vehicle_state.otaCurrentVersionWeek.value }}.{{ vehicle_state.otaCurrentVersionNumber.value }}</span>
                            </div>
                            <div>
                                VIN: {{ vehicle.vin }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Vehicle Controls -->
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sliders-h me-2"></i>Vehicle Controls
                </h5>
            </div>
            <div class="card-body">
                <div id="controls-warning" class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Note:</strong> To use vehicle controls, you need to configure phone key details.
                </div>
                
                <div class="row g-3">
                    <!-- Lock/Unlock -->
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 py-3" disabled data-command="LOCK">
                            <i class="fas fa-lock me-2"></i>Lock Vehicle
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 py-3" disabled data-command="UNLOCK">
                            <i class="fas fa-unlock me-2"></i>Unlock Vehicle
                        </button>
                    </div>
                    
                    <!-- Climate -->
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 py-3" disabled data-command="CLIMATE_START">
                            <i class="fas fa-snowflake me-2"></i>Start Climate
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 py-3" disabled data-command="CLIMATE_STOP">
                            <i class="fas fa-power-off me-2"></i>Stop Climate
                        </button>
                    </div>
                    
                    <!-- Frunk -->
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 py-3" disabled data-command="OPEN_FRUNK">
                            <i class="fas fa-box-open me-2"></i>Open Frunk
                        </button>
                    </div>
                    
                    <!-- Charging -->
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 py-3" disabled data-command="START_CHARGING">
                            <i class="fas fa-bolt me-2"></i>Start Charging
                        </button>
                    </div>
                    
                    <!-- Honk & Flash -->
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 py-3" disabled data-command="HONK_AND_FLASH">
                            <i class="fas fa-volume-up me-2"></i>Honk & Flash
                        </button>
                    </div>
                    
                    <!-- Wake Vehicle -->
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 py-3" disabled data-command="WAKE_VEHICLE">
                            <i class="fas fa-bell me-2"></i>Wake Vehicle
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#phoneKeyModal">
                        <i class="fas fa-key me-2"></i>Configure Phone Key
                    </a>
                </div>
            </div>
        </div>

        <!-- Command History -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Command History
                </h5>
            </div>
            <div class="card-body">
                <div id="command-history-container">
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-info-circle me-2"></i>No command history available
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location -->
<div class="row mb-4" id="location-section">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i>Vehicle Location
                </h5>
            </div>
            <div class="card-body">
                {% if vehicle_state.gnssLocation and vehicle_state.gnssLocation.latitude %}
                <div id="map" style="height: 400px;"></div>
                {% else %}
                <div id="map-placeholder" class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Vehicle location is currently unavailable.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Phone Key Modal -->
<div class="modal fade" id="phoneKeyModal" tabindex="-1" aria-labelledby="phoneKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="phoneKeyModalLabel">Configure Phone Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Important:</strong> To use vehicle controls, you need to provide your phone key credentials.
                    These are required to authenticate commands to your vehicle.
                </div>
                
                <form id="phoneKeyForm">
                    <div class="mb-3">
                        <label for="phoneId" class="form-label">Phone ID</label>
                        <input type="text" class="form-control" id="phoneId" 
                               placeholder="Enter your Rivian phone ID">
                    </div>
                    <div class="mb-3">
                        <label for="identityId" class="form-label">Identity ID</label>
                        <input type="text" class="form-control" id="identityId" 
                               placeholder="Enter your Rivian identity ID">
                    </div>
                    <div class="mb-3">
                        <label for="vehicleKey" class="form-label">Vehicle Key</label>
                        <input type="text" class="form-control" id="vehicleKey" 
                               placeholder="Enter your vehicle public key">
                    </div>
                    <div class="mb-3">
                        <label for="privateKey" class="form-label">Private Key</label>
                        <textarea class="form-control" id="privateKey" rows="3" 
                                 placeholder="Enter your private key"></textarea>
                    </div>
                </form>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Note:</strong> These credentials are stored only in your browser's local storage and are never sent 
                    to our servers. They are required to generate secure signatures for vehicle commands.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePhoneKey">Save Configuration</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden vehicle data for JS -->
<script type="application/json" id="vehicle-data">
{
    "id": "{{ vehicle.id }}",
    "vin": "{{ vehicle.vin }}",
    "name": "{{ vehicle.name }}",
    "model": "{{ vehicle.vehicle.model }}"
}
</script>
{% endblock %}

{% block scripts %}
<!-- Load necessary scripts -->
<script src="{{ url_for('static', filename='js/socket-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/vehicle-controls.js') }}"></script>

<script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Format timestamps
        formatTimestamps();
        
        // Initialize map if location available
        {% if vehicle_state.gnssLocation and vehicle_state.gnssLocation.latitude %}
        initMap(
            {{ vehicle_state.gnssLocation.latitude }}, 
            {{ vehicle_state.gnssLocation.longitude }}
        );
        {% endif %}
        
        // Initialize real-time updates
        initRealTimeUpdates();
        
        // Load command history
        loadCommandHistory();
    });
    
    // Format timestamps to local time
    function formatTimestamps() {
        const lastSync = document.getElementById('last-sync');
        if (lastSync) {
            const date = new Date("{{ vehicle_state.cloudConnection.lastSync }}");
            lastSync.textContent = date.toLocaleString();
        }
    }
    
    // Initialize map
    function initMap(lat, lng) {
        // This is a placeholder for a map implementation
        // You can use Google Maps, Leaflet, or similar
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.innerHTML = `
                <div class="alert alert-info">
                    <p>Vehicle location: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                    <p>Map functionality will be implemented in a future update.</p>
                </div>
            `;
        }
    }
    
    // Initialize real-time updates via WebSockets
    async function initRealTimeUpdates() {
        const connectionStatus = document.getElementById('connection-status');
        
        try {
            // Get vehicle data from hidden element
            const vehicleDataElement = document.getElementById('vehicle-data');
            if (!vehicleDataElement) {
                throw new Error('Vehicle data not found');
            }
            
            const vehicleData = JSON.parse(vehicleDataElement.textContent);
            
            // Connect to Socket.IO server
            await rivianSocket.connect();
            connectionStatus.textContent = 'Connected to server. Authenticating...';
            
            // Get API token for WebSocket authentication
            const tokenResponse = await fetch('/auth/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            });
            
            if (!tokenResponse.ok) {
                throw new Error('Failed to get authentication token');
            }
            
            const tokenData = await tokenResponse.json();
            
            // Authenticate with Socket.IO server
            await rivianSocket.authenticate(
                "{{ current_user.id }}", 
                tokenData.token
            );
            
            connectionStatus.textContent = 'Authenticated. Subscribing to vehicle updates...';
            
            // Subscribe to vehicle updates
            await rivianSocket.subscribeToVehicle(vehicleData.id);
            
            connectionStatus.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Real-time updates activated';
            
            // Handle vehicle updates
            rivianSocket.on('vehicle_update', handleVehicleUpdate);
            
            // Handle disconnect
            rivianSocket.on('disconnect', () => {
                connectionStatus.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>Disconnected. Trying to reconnect...';
            });
            
            // Handle reconnect
            rivianSocket.on('connect', () => {
                connectionStatus.textContent = 'Reconnected. Reestablishing subscription...';
                
                // Resubscribe to vehicle updates
                rivianSocket.authenticate(
                    "{{ current_user.id }}", 
                    tokenData.token
                ).then(() => {
                    return rivianSocket.subscribeToVehicle(vehicleData.id);
                }).then(() => {
                    connectionStatus.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Real-time updates activated';
                }).catch(error => {
                    console.error('Failed to resubscribe:', error);
                    connectionStatus.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>Failed to resubscribe to updates';
                });
            });
        } catch (error) {
            console.error('Error initializing real-time updates:', error);
            connectionStatus.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>Failed to initialize real-time updates';
        }
    }
    
    // Handle vehicle update
    function handleVehicleUpdate(data) {
        console.log('Received vehicle update:', data);
        
        // Update battery level
        if (data.batteryLevel) {
            const batteryPercent = document.getElementById('battery-percentage');
            const batteryProgress = document.getElementById('battery-progress');
            
            if (batteryPercent) {
                batteryPercent.textContent = `${data.batteryLevel.value.toFixed(1)}%`;
            }
            
            if (batteryProgress) {
                batteryProgress.style.width = `${data.batteryLevel.value}%`;
                batteryProgress.textContent = `${data.batteryLevel.value.toFixed(1)}%`;
            }
        }
        
        // Update range
        if (data.distanceToEmpty) {
            const distanceToEmpty = document.getElementById('distance-to-empty');
            if (distanceToEmpty) {
                distanceToEmpty.textContent = data.distanceToEmpty.value;
            }
        }
        
        // Update power state
        if (data.powerState) {
            const powerState = document.getElementById('power-state');
            const powerStateIcon = document.getElementById('power-state-icon');
            
            if (powerState) {
                powerState.textContent = data.powerState.value.charAt(0).toUpperCase() + data.powerState.value.slice(1);
            }
            
            if (powerStateIcon) {
                if (data.powerState.value === 'ready') {
                    powerStateIcon.classList.add('text-success');
                    powerStateIcon.classList.remove('text-secondary');
                } else {
                    powerStateIcon.classList.remove('text-success');
                    powerStateIcon.classList.add('text-secondary');
                }
            }
        }
        
        // Update charging state
        if (data.chargerState) {
            const chargingState = document.getElementById('charging-state');
            const chargingStateIcon = document.getElementById('charging-state-icon');
            
            if (chargingState) {
                chargingState.textContent = data.chargerState.value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
            
            if (chargingStateIcon) {
                if (data.chargerState.value === 'charging_active') {
                    chargingStateIcon.classList.add('text-success');
                    chargingStateIcon.classList.remove('text-secondary');
                } else {
                    chargingStateIcon.classList.remove('text-success');
                    chargingStateIcon.classList.add('text-secondary');
                }
            }
        }
        
        // Update location
        if (data.gnssLocation) {
            const lat = data.gnssLocation.latitude;
            const lng = data.gnssLocation.longitude;
            
            // Update map if it exists
            const mapPlaceholder = document.getElementById('map-placeholder');
            const map = document.getElementById('map');
            
            if (mapPlaceholder && !map) {
                // Convert placeholder to map
                const mapContainer = document.createElement('div');
                mapContainer.id = 'map';
                mapContainer.style.height = '400px';
                mapPlaceholder.parentNode.replaceChild(mapContainer, mapPlaceholder);
                
                // Initialize map with new location
                initMap(lat, lng);
            } else if (map) {
                // Update existing map (implementation depends on map library)
                // For now, just update the text
                map.innerHTML = `
                    <div class="alert alert-info">
                        <p>Vehicle location: ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                        <p>Map functionality will be implemented in a future update.</p>
                    </div>
                `;
            }
        }
    }
    
    // Load command history
    async function loadCommandHistory() {
        try {
            const response = await fetch(`/api/vehicle/{{ vehicle.id }}/commands/history`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch command history');
            }
            
            const data = await response.json();
            
            if (data.status === 'success' && data.commands && data.commands.length > 0) {
                const historyContainer = document.getElementById('command-history-container');
                historyContainer.innerHTML = '';
                
                // Display last 5 commands
                const commands = data.commands.slice(0, 5);
                
                commands.forEach(cmd => {
                    const date = new Date(cmd.timestamp);
                    const statusClass = cmd.status === 3 ? 'success' : 
                                        cmd.status === 2 ? 'danger' : 
                                        cmd.status === 1 ? 'warning' : 'secondary';
                    const statusText = cmd.status === 3 ? 'Completed' : 
                                      cmd.status === 2 ? 'Failed' : 
                                      cmd.status === 1 ? 'Executing' : 'Pending';
                    
                    const item = document.createElement('div');
                    item.className = 'command-history-item';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${cmd.command}</span>
                                <div class="small text-muted">${date.toLocaleString()}</div>
                            </div>
                            <span class="badge bg-${statusClass}">${statusText}</span>
                        </div>
                    `;
                    
                    historyContainer.appendChild(item);
                });
            }
        } catch (error) {
            console.error('Error loading command history:', error);
        }
    }
</script>
{% endblock %}