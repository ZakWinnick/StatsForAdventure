<!DOCTYPE html>
<html>
<head>
    <title>Stats for Adventure</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="/static/commands.js"></script>
    <script>
        // Store tokens in localStorage for client-side persistence
        function storeTokens(tokens) {
            localStorage.setItem('rivian_tokens', JSON.stringify(tokens));
            document.getElementById('auth-status').innerText = 'Authenticated';
            document.getElementById('auth-status').classList.add('text-green-500');
            document.getElementById('auth-status').classList.remove('text-red-500');
            
            // If we're authenticated, load user info
            loadUserInfo();
            loadAvailableCommands();
        }
        
        function clearTokens() {
            localStorage.removeItem('rivian_tokens');
            document.getElementById('auth-status').innerText = 'Not Authenticated';
            document.getElementById('auth-status').classList.add('text-red-500');
            document.getElementById('auth-status').classList.remove('text-green-500');
        }
        
        // Modified login handling
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Login failed');
                }
                
                const data = await response.json();
                console.log("User info response:", data);
                
                if (data.otp_needed) {
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('otp-form').classList.remove('hidden');
                    document.getElementById('otp-username').value = username;
                    document.getElementById('otp-token').value = data.otp_token;
                    document.getElementById('csrf-token').value = data.csrf_token;
                    document.getElementById('app-session-token').value = data.app_session_token;
                } else {
                    storeTokens(data);
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('authenticated-view').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('login-result').innerHTML = 
                    `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Error: ${error.message}</div>`;
            }
        }
        
        // Modified OTP validation handling
        async function handleOtpValidation(event) {
            event.preventDefault();
            
            const username = document.getElementById('otp-username').value;
            const otpCode = document.getElementById('otp-code').value;
            const otpToken = document.getElementById('otp-token').value;
            const csrfToken = document.getElementById('csrf-token').value;
            const appSessionToken = document.getElementById('app-session-token').value;
            
            const formData = new FormData();
            formData.append('username', username);
            formData.append('otp_code', otpCode);
            formData.append('otp_token', otpToken);
            formData.append('csrf_token', csrfToken);
            formData.append('app_session_token', appSessionToken);
            
            try {
                const response = await fetch('/api/auth/validate-otp', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('OTP validation failed');
                }
                
                const data = await response.json();
                console.log("User info response:", data);
                storeTokens(data);
                document.getElementById('otp-form').classList.add('hidden');
                document.getElementById('authenticated-view').classList.remove('hidden');
            } catch (error) {
                document.getElementById('otp-result').innerHTML = 
                    `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Error: ${error.message}</div>`;
            }
        }
        
        async function loadUserInfo() {
            console.log("Loading user info");
            
            const tokens = JSON.parse(localStorage.getItem('rivian_tokens'));
            if (!tokens) return;
            
            try {
                console.log("Tokens:", tokens);
                const response = await fetch('/api/vehicles/user-info', {
                    headers: {
                        'X-CSRF-Token': tokens.csrf_token,
                        'X-App-Session-Token': tokens.app_session_token,
                        'X-User-Session-Token': tokens.user_session_token
                    }
                });
                
                // Get the full response text for debugging
                const responseText = await response.text();
                console.log("Raw response:", response.status, responseText);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch user info: ${response.status} ${responseText.substring(0, 150)}...`);
                }
                
                // Try to parse the response as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error("Error parsing JSON response:", e);
                    throw new Error("Invalid JSON response from server");
                }
                
                console.log("User info response:", data);
                const vehicles = data?.data?.currentUser?.vehicles || [];
                renderVehicles(vehicles);
                setupVehicleCommandsUI(vehicles);
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('vehicles-container').innerHTML = 
                    `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Error loading vehicles: ${error.message}</div>`;
            }
        }
        
        function setupVehicleCommandsUI(vehicles) {
            const vehicleSelect = document.getElementById("vehicle-select");
            if (!vehicleSelect) return;
            
            // Clear existing options
            vehicleSelect.innerHTML = "";
            
            vehicles.forEach(vehicle => {
                const option = document.createElement("option");
                option.value = JSON.stringify({
                    id: vehicle.id,
                    phoneId: vehicle?.vas?.vasVehicleId || "",
                    vehicleKey: vehicle?.vas?.vehiclePublicKey || "",
                    // We need to add identityId from enrolled phones - this is simplified
                    identityId: ""
                });
                option.textContent = `${vehicle.name || "Unnamed"} (${vehicle.vin})`;
                vehicleSelect.appendChild(option);
            });
            
            // Set up command button
            const sendBtn = document.getElementById("send-command-btn");
            if (sendBtn) {
                sendBtn.addEventListener("click", () => {
                    const vehicleData = JSON.parse(vehicleSelect.value || "{}");
                    const privateKey = document.getElementById("private-key").value.trim();
                    
                    if (!privateKey) {
                        alert("Please enter your phone private key");
                        return;
                    }
                    
                    // For a real implementation, you would need to get the correct identityId
                    // from the user's enrolled phones
                    vehicleData.privateKey = privateKey;
                    
                    sendVehicleCommand(vehicleData.id, vehicleData);
                });
            }
        }
        
        function renderVehicles(vehicles) {
            const container = document.getElementById('vehicles-container');
            
            if (vehicles.length === 0) {
                container.innerHTML = '<div class="bg-yellow-100 text-yellow-700 p-4 rounded-lg">No vehicles found</div>';
                return;
            }
            
            let html = '';
            vehicles.forEach(vehicle => {
                html += `
                <div class="bg-white rounded-lg shadow-md p-6 mb-4">
                    <h3 class="text-xl font-semibold mb-2">${vehicle.name || 'Unnamed Vehicle'}</h3>
                    <p class="mb-2"><strong>VIN:</strong> ${vehicle.vin || 'N/A'}</p>
                    <div class="flex space-x-2 mt-4">
                        <button 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            onclick="loadVehicleState('${vehicle.vin}')"
                        >
                            Get Vehicle State
                        </button>
                        <button 
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                            onclick="loadChargingSession('${vehicle.vin}')"
                        >
                            Get Charging Info
                        </button>
                    </div>
                    <div id="vehicle-state-${vehicle.vin}" class="mt-4"></div>
                    <div id="charging-info-${vehicle.vin}" class="mt-4"></div>
                </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function loadVehicleState(vin) {
            const tokens = JSON.parse(localStorage.getItem('rivian_tokens'));
            if (!tokens) return;
            
            const stateElement = document.getElementById(`vehicle-state-${vin}`);
            stateElement.innerHTML = '<div class="text-gray-600">Loading vehicle state...</div>';
            
            try {
                console.log("Tokens:", tokens);
                const response = await fetch(`/api/vehicles/${vin}/state`, {
                    headers: {
                        'X-CSRF-Token': tokens.csrf_token,
                        'X-App-Session-Token': tokens.app_session_token,
                        'X-User-Session-Token': tokens.user_session_token
                    }
                });
                
                // Get response text for debugging
                const responseText = await response.text();
                console.log("Vehicle state raw response:", responseText);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch vehicle state: ${response.status}`);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error("Error parsing JSON vehicle state:", e);
                    throw new Error("Invalid JSON response from server");
                }
                
                console.log("Vehicle state response:", data);
                const state = data?.data?.vehicleState || {};
                
                let html = `
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">Vehicle State</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <div><strong>Battery Level:</strong> ${state.batteryLevel?.value || 'N/A'}%</div>
                        <div><strong>Range:</strong> ${state.distanceToEmpty?.value || 'N/A'} miles</div>
                        <div><strong>Power State:</strong> ${state.powerState?.value || 'N/A'}</div>
                        <div><strong>Doors Locked:</strong> ${state.doorFrontLeftLocked?.value === 'locked' ? 'Yes' : 'No'}</div>
                    </div>
                </div>
                `;
                
                stateElement.innerHTML = html;
            } catch (error) {
                console.error('Error loading vehicle state:', error);
                stateElement.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Error loading vehicle state: ${error.message}</div>`;
            }
        }
        
        async function loadChargingSession(vin) {
            const tokens = JSON.parse(localStorage.getItem('rivian_tokens'));
            if (!tokens) return;
            
            const chargingElement = document.getElementById(`charging-info-${vin}`);
            chargingElement.innerHTML = '<div class="text-gray-600">Loading charging info...</div>';
            
            try {
                console.log("Tokens:", tokens);
                const response = await fetch(`/api/vehicles/${vin}/charging`, {
                    headers: {
                        'X-CSRF-Token': tokens.csrf_token,
                        'X-App-Session-Token': tokens.app_session_token,
                        'X-User-Session-Token': tokens.user_session_token
                    }
                });
                
                // Get response text for debugging
                const responseText = await response.text();
                console.log("Charging info raw response:", responseText);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch charging info: ${response.status}`);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error("Error parsing JSON charging info:", e);
                    throw new Error("Invalid JSON response from server");
                }
                
                console.log("Charging info response:", data);
                const info = data?.data?.getLiveSessionData || {};
                
                let html = `
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">Charging Information</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <div><strong>State:</strong> ${info.vehicleChargerState?.value || 'N/A'}</div>
                        <div><strong>Power:</strong> ${info.power?.value || 'N/A'} kW</div>
                        <div><strong>Range Added:</strong> ${info.rangeAddedThisSession?.value || 'N/A'} miles</div>
                        <div><strong>Time Remaining:</strong> ${info.timeRemaining?.value || 'N/A'} min</div>
                    </div>
                </div>
                `;
                
                chargingElement.innerHTML = html;
            } catch (error) {
                console.error('Error loading charging info:', error);
                chargingElement.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Error loading charging info: ${error.message}</div>`;
            }
        }
        
        // Check auth status on load
        document.addEventListener('DOMContentLoaded', function() {
            const tokens = localStorage.getItem('rivian_tokens');
            if (tokens) {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('authenticated-view').classList.remove('hidden');
                document.getElementById('auth-status').innerText = 'Authenticated';
                document.getElementById('auth-status').classList.add('text-green-500');
                document.getElementById('auth-status').classList.remove('text-red-500');
                loadUserInfo();
                loadAvailableCommands();
            } else {
                clearTokens();
            }
            
            // Set up form submit handlers
            document.getElementById('login-button').addEventListener('click', function(event) {
                event.preventDefault();
                handleLogin(event);
            });
            document.getElementById('otp-button').addEventListener('click', function(event) {
                event.preventDefault();
                handleOtpValidation(event);
            });
        });
    </script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Stats for Adventure</h1>
        <div class="text-center mb-4">
            <span>Status: </span>
            <span id="auth-status" class="font-bold text-red-500">Not Authenticated</span>
        </div>
        
        <!-- Login Form -->
        <div id="login-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Login to Rivian</h2>
            <form id="rivian-login-form" onsubmit="event.preventDefault(); handleLogin(event);">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="username">Rivian Username/Email</label>
                    <input class="w-full px-3 py-2 border rounded-lg" type="email" id="username" name="username" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="password">Password</label>
                    <input class="w-full px-3 py-2 border rounded-lg" type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button id="login-button" type="button" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Login</button>
            </form>
            <div id="login-result" class="mt-4"></div>
        </div>
        
        <!-- OTP Form -->
        <div id="otp-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Enter Verification Code</h2>
            <p class="mb-4">Please enter the verification code sent to your phone.</p>
            <form id="rivian-otp-form">
                <input type="hidden" id="otp-username" name="username">
                <input type="hidden" id="otp-token" name="otp_token">
                <input type="hidden" id="csrf-token" name="csrf_token">
                <input type="hidden" id="app-session-token" name="app_session_token">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="otp-code">Verification Code</label>
                    <input class="w-full px-3 py-2 border rounded-lg" type="text" id="otp-code" name="otp_code" required>
                </div>
                <button id="otp-button" type="button" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Verify</button>
            </form>
            <div id="otp-result" class="mt-4"></div>
        </div>
        
        <!-- Authenticated View -->
        <div id="authenticated-view" class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Your Rivian Dashboard</h2>
            
            <!-- Debug Info -->
            <div id="debug-info" class="mb-6 p-4 bg-gray-100 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Debug Information</h3>
                <p>If you're experiencing issues, check the browser console (F12) for detailed error messages.</p>
            </div>
            
            <!-- Vehicle Commands -->
            <div id="vehicle-commands" class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Vehicle Commands</h3>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="command-select">Select Command</label>
                        <select id="command-select" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Loading commands...</option>
                        </select>
                    </div>
                    <div id="command-params-container" class="mb-4"></div>
                    <div id="command-vehicle-select" class="mb-4">
                        <label class="block text-gray-700 mb-2" for="vehicle-select">Select Vehicle</label>
                        <select id="vehicle-select" class="w-full px-3 py-2 border rounded-lg"></select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="private-key">Phone Private Key (keep this secure!)</label>
                        <textarea id="private-key" class="w-full px-3 py-2 border rounded-lg" rows="3" placeholder="Your enrolled phone private key"></textarea>
                        <p class="text-sm text-gray-600 mt-1">
                            This key is generated when you enroll your phone as a key in the Rivian mobile app.
                            For testing, you can use a placeholder key.
                        </p>
                    </div>
                    <button id="send-command-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Send Command</button>
                    <div id="command-result" class="mt-4"></div>
                </div>
            </div>
            
            <!-- Vehicles container -->
            <div id="vehicles-container" class="mb-6">
                <div class="text-gray-600">Loading your vehicles...</div>
            </div>
            
            <button 
                class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600"
                onclick="clearTokens(); document.getElementById('authenticated-view').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden');"
            >
                Logout
            </button>
        </div>
    </div>
</body>
</html>